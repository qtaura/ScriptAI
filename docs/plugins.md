# Plugin Development

This guide explains how to extend ScriptAI with custom model adapters via a simple plugin API.

## Overview
- Drop Python files under `plugins/` or set `SCRIPT_AI_PLUGINS_DIR` to point at any folder.
- Each plugin module can expose a `register(register_adapter)` function.
- Use `register_adapter(id, name, adapter_cls_or_factory, is_available?, description?)` to register your adapter.
- Registered adapters appear in the `/models` endpoint when `is_available()` returns `True`.

## Quick Start
1. Create a new file under `plugins/` (e.g., `plugins/my_adapter.py`).
2. Implement an adapter class that inherits `model_adapters.ModelAdapter` and defines `generate(prompt: str)`.
3. Provide an `is_available()` function (optional) to gate the adapter by credentials/runtime.
4. Implement `register(register_adapter)` to register the adapter.

Example:
```python
from typing import Optional, Tuple
from model_adapters import ModelAdapter

class MyAdapter(ModelAdapter):
    def generate(self, prompt: str) -> Tuple[Optional[str], Optional[str]]:
        # Return code and None on success; None and an error string on failure
        return f"# Generated by MyAdapter\n# Prompt: {prompt}\nprint('hello')\n", None

# Optional: enable only when credentials are present
import os

def is_available() -> bool:
    return bool(os.getenv('MY_API_KEY'))

# Registration entry point called by the loader

def register(register_adapter):
    register_adapter(
        id="myadapter",
        name="My Adapter",
        adapter_cls_or_factory=MyAdapter,
        is_available=is_available,
        description="Example adapter that returns a small stub.",
    )
```

## Adapter Contract
- `ModelAdapter.generate(prompt: str) -> Tuple[Optional[str], Optional[str]]`
  - Return `(code, None)` on success.
  - Return `(None, "error message")` on failure.
- Avoid raising exceptions; return a friendly error string instead.
- Keep network timeouts reasonable (e.g., `30s`).

## Availability & Discovery
- `is_available()` decides if your adapter appears in `/models`.
- Use environment checks for cloud providers (e.g., `os.getenv('MY_API_KEY')`).
- The loader scans `.py` files in `plugins/` (excluding private names) and imports them safely.
- If a module defines `register(register_adapter)`, it will be called to register the adapter.
- Failures during loading are swallowed to avoid breaking app startup.

## UI Integration
- The frontend reads `/models` and `modelCards.json`/`/model-profiles` to build the selector.
- To show your adapter with a friendly card, either:
  - Add an entry to `frontend/public/modelCards.json` (if present), or
  - Extend `/model-profiles` to include your adapter’s metadata (badge, speed, cost, features).
- Otherwise, the adapter will still be usable via API/CLI, but may not have a polished card.

## Testing Your Plugin
- API: `curl -X POST http://127.0.0.1:5000/generate -H 'Content-Type: application/json' -d '{"prompt":"hello","model":"myadapter"}'`
- CLI: `python cli.py "hello" --model myadapter` (if you wire CLI switching to your model id).
- UI: run the SPA and check the model selector after adding your adapter to profiles/cards.

## Configuration
- `SCRIPT_AI_PLUGINS_DIR`: absolute/relative path to your plugins folder. If unset, defaults to `./plugins/`.
- Provider credentials: environment variables as needed (e.g., `MY_API_KEY`, `MY_API_URL`).

## Best Practices
- Keep adapter `id` unique to avoid overriding built-in adapters.
- Provide clear error messages for rate limits, auth errors, and timeouts.
- Do not hard-crash; return `(None, "error message")` on failure.
- Consider logging (via your own logic) for troubleshooting, but avoid noisy output.

## Reference Template
See `plugins/hello_world_adapter.py` for a minimal, copy‑paste template.